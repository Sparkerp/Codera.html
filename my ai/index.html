<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Codera AI — Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f10; --panel:#161616; --muted:#9a9a9a; --accent:#2f2f2f; --card:#1c1c1c;
  --primary:#bfbfbf; --pill:#2a2a2a; --highlight:#3a3a3a;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#0b0b0b,#121214); color:var(--primary); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.app{display:grid; grid-template-columns:260px 1fr; height:100vh; gap:14px; padding:14px;}
.sidebar{background:var(--panel); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:0 6px 18px rgba(0,0,0,0.6);}
.brand{display:flex; gap:10px; align-items:center;}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#1b1b1b,#2b2b2b);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);font-size:18px}
.title{font-weight:600;font-size:14px;color:var(--primary)}
.thread-list{flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px; padding-top:8px;}
.thread{padding:10px;border-radius:8px;background:transparent;cursor:pointer;display:flex;align-items:center;gap:8px;border:1px solid transparent}
.thread.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(255,255,255,0.03);}
.thread .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--primary);}
.controls-row{display:flex;gap:8px}
.btn{background:var(--pill); color:var(--primary); border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
.small{padding:6px 8px;font-size:13px}
.center-area{display:flex;flex-direction:column;gap:12px;height:100%}
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.header .left{display:flex;align-items:center;gap:12px}
.header .h-title{font-weight:700}
.header .subtitle{color:var(--muted);font-size:13px}
.main{flex:1;display:flex;flex-direction:column;gap:12px;min-height:0}
.chat-area{flex:1;overflow:auto;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.center-message{display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:1.05rem}
.message{max-width:78%;margin:8px 0;padding:12px;border-radius:12px;position:relative;box-shadow:0 6px 12px rgba(0,0,0,0.6);word-break:break-word}
.user{margin-left:auto;background:linear-gradient(180deg,#1b1b1b,#242424);border:1px solid rgba(255,255,255,0.02)}
.ai{margin-right:auto;background:linear-gradient(180deg,#191919,#232323);border:1px solid rgba(255,255,255,0.02)}
.meta{font-size:12px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.content{white-space:pre-wrap}
.separator{height:1px;background:var(--accent);margin:12px 0;border-radius:2px}
.code-block{background:#0b0b0b;padding:12px;border-radius:8px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace}
.code-tools{position:absolute;right:10px;top:10px;display:flex;gap:6px}
.tool-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 8px;border-radius:6px;font-size:12px;cursor:pointer}
.media{max-width:100%;border-radius:8px;margin-top:8px;display:block}
.input-row{display:flex;gap:10px;align-items:center;padding:12px;background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.input{flex:1;padding:12px;border-radius:10px;background:#121212;border:1px solid rgba(255,255,255,0.02);color:var(--primary);outline:none;font-size:15px}
.icon-btn{background:var(--pill);border:none;padding:10px;border-radius:10px;cursor:pointer}
.inline-actions{display:flex;gap:8px;margin-top:8px}
.thread-actions{display:flex;gap:6px}
.thread-name-edit{flex:1;padding:8px;border-radius:8px;background:#111;border:1px solid rgba(255,255,255,0.02);color:var(--primary)}
.footer-note{font-size:12px;color:var(--muted);text-align:center;padding:6px}
.empty-hint{color:var(--muted);font-size:13px;text-align:center;padding:12px}
.msg-actions{position:absolute;left:10px;bottom:8px;display:flex;gap:6px}
.msg-action{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px;border-radius:6px;font-size:12px;cursor:pointer}
.thread-meta{font-size:12px;color:var(--muted)}
@media (max-width:900px){
  .app{grid-template-columns:1fr; padding:10px}
  .sidebar{order:2;height:220px}
}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="brand">
      <div class="logo">CA</div>
      <div>
        <div class="title">Codera AI</div>
        <div class="thread-meta">Gray theme · Coding assistant</div>
      </div>
    </div>
    <div class="controls-row">
      <button id="newChatBtn" class="btn small">+ New Chat</button>
      <button id="importBtn" class="btn ghost small">Import</button>
    </div>
    <div id="threadList" class="thread-list"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="googleImgBtn" class="btn ghost small">Search Google Images</button>
      <button id="unsplashBtn" class="btn small small">Unsplash</button>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <input id="apiKeyInput" placeholder="API key (optional)" value="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" style="flex:1;padding:8px;border-radius:8px;background:#0f0f0f;border:1px solid rgba(255,255,255,0.03);color:var(--primary)" />
    </div>
    <div class="footer-note">Tip: click Search Google Images to open images.google and paste an image URL into the message input to embed.</div>
  </div>

  <div class="center-area">
    <div class="header">
      <div class="left">
        <div class="h-title" id="currentThreadTitle">New Chat</div>
        <div class="subtitle" id="currentThreadSubtitle">Coding & answers</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="threadBtns" class="thread-actions">
          <button id="renameThreadBtn" class="btn ghost small">Rename</button>
          <button id="deleteThreadBtn" class="btn ghost small">Delete</button>
        </div>
        <div style="width:10px"></div>
      </div>
    </div>

    <div class="main">
      <div id="chatArea" class="chat-area">
        <div id="centerMsg" class="center-message">Hi there — ask me anything. You can edit your messages after sending, create new chats, and paste image URLs.</div>
      </div>

      <div style="padding:8px">
        <div class="input-row">
          <input id="userInput" class="input" placeholder="Type a message or paste an image URL (https://...jpg) and press Enter" />
          <button id="sendBtn" class="icon-btn">Send</button>
          <button id="editModeBtn" class="icon-btn">Edit</button>
          <button id="clearBtn" class="icon-btn">Clear</button>
        </div>

        <div class="inline-actions">
          <button id="generateImageBtn" class="btn small">Generate Image</button>
          <button id="generateVideoBtn" class="btn small">Generate Video</button>
          <button id="downloadChatBtn" class="btn ghost small">Download Chat</button>
          <button id="muteBtn" class="btn ghost small">Unmute</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const threadListEl = document.getElementById('threadList');
const chatArea = document.getElementById('chatArea');
const centerMsg = document.getElementById('centerMsg');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const newChatBtn = document.getElementById('newChatBtn');
const apiKeyInput = document.getElementById('apiKeyInput');
const googleImgBtn = document.getElementById('googleImgBtn');
const unsplashBtn = document.getElementById('unsplashBtn');
const renameThreadBtn = document.getElementById('renameThreadBtn');
const deleteThreadBtn = document.getElementById('deleteThreadBtn');
const currentThreadTitle = document.getElementById('currentThreadTitle');
const downloadChatBtn = document.getElementById('downloadChatBtn');
const clearBtn = document.getElementById('clearBtn');
const editModeBtn = document.getElementById('editModeBtn');
const generateImageBtn = document.getElementById('generateImageBtn');
const generateVideoBtn = document.getElementById('generateVideoBtn');
const muteBtn = document.getElementById('muteBtn');

let threads = [];
let activeThreadId = null;
let editMode = false;
let mute = false;

function uid(prefix='t') {
  return prefix + Math.random().toString(36).slice(2,9);
}

function saveState() {
  localStorage.setItem('codera_threads_v1', JSON.stringify(threads));
}

function loadState() {
  const raw = localStorage.getItem('codera_threads_v1');
  if (raw) {
    try{ threads = JSON.parse(raw); }catch(e){ threads = []; }
  }
  if (!threads.length) {
    const id = uid();
    threads.push({id, name:'New Chat', messages:[]});
  }
  activeThreadId = threads[0].id;
  renderThreads();
  renderActiveThread();
}

function renderThreads() {
  threadListEl.innerHTML = '';
  threads.forEach(t => {
    const el = document.createElement('div');
    el.className = 'thread' + (t.id===activeThreadId ? ' active' : '');
    el.dataset.id = t.id;
    const name = document.createElement('div'); name.className='name'; name.textContent = t.name;
    const meta = document.createElement('div'); meta.className='thread-meta'; meta.style.fontSize='12px'; meta.textContent = t.messages.length ? `${t.messages.length} msgs` : 'empty';
    el.appendChild(name);
    el.appendChild(meta);
    el.addEventListener('click', ()=> {
      activeThreadId = t.id;
      renderThreads();
      renderActiveThread();
    });
    threadListEl.appendChild(el);
  });
}

function renderActiveThread() {
  const thread = threads.find(t=>t.id===activeThreadId);
  currentThreadTitle.textContent = thread.name || 'Chat';
  chatArea.innerHTML = '';
  if (!thread.messages.length) {
    chatArea.appendChild(centerMsg);
    centerMsg.style.display = 'flex';
    return;
  } else {
    centerMsg.style.display = 'none';
  }
  thread.messages.forEach((m, idx) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'message ' + (m.role==='user' ? 'user' : 'ai');
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = m.role==='user' ? 'You' : 'Codera';
    wrapper.appendChild(meta);
    const content = document.createElement('div'); content.className='content';
    if (m.type==='code') {
      const codeWrap = document.createElement('div'); codeWrap.className='code-block'; codeWrap.textContent = m.content;
      const tools = document.createElement('div'); tools.className='code-tools';
      const copyBtn = document.createElement('button'); copyBtn.className='tool-btn'; copyBtn.textContent='Copy'; copyBtn.addEventListener('click',()=>navigator.clipboard.writeText(m.content));
      const dlBtn = document.createElement('button'); dlBtn.className='tool-btn'; dlBtn.textContent='Download'; dlBtn.addEventListener('click',()=>downloadFile('code.txt', m.content));
      tools.appendChild(copyBtn); tools.appendChild(dlBtn);
      wrapper.appendChild(codeWrap); wrapper.appendChild(tools);
    } else {
      parseAndRender(content, m.content);
    }
    wrapper.appendChild(content);
    const actions = document.createElement('div'); actions.className='msg-actions';
    if (m.role==='user') {
      const editBtn = document.createElement('button'); editBtn.className='msg-action'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=> startEditMessage(idx));
      const delBtn = document.createElement('button'); delBtn.className='msg-action'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=> deleteMessage(idx));
      actions.appendChild(editBtn); actions.appendChild(delBtn);
    } else {
      const copyBtn = document.createElement('button'); copyBtn.className='msg-action'; copyBtn.textContent='Copy'; copyBtn.addEventListener('click', ()=> navigator.clipboard.writeText(m.content));
      actions.appendChild(copyBtn);
    }
    wrapper.appendChild(actions);
    chatArea.appendChild(wrapper);
  });
  chatArea.scrollTop = chatArea.scrollHeight;
}

function downloadFile(filename, text) {
  const blob = new Blob([text], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function startEditMessage(index) {
  const thread = threads.find(t=>t.id===activeThreadId);
  const msg = thread.messages[index];
  userInput.value = msg.content;
  editMode = index;
  editModeBtn.textContent = 'Editing';
  userInput.focus();
}

function deleteMessage(index) {
  const thread = threads.find(t=>t.id===activeThreadId);
  thread.messages.splice(index,1);
  saveState();
  renderActiveThread();
  renderThreads();
}

function parseAndRender(container, text) {
  const fence = /```([\w+-]*)\n([\s\S]*?)```/g;
  let m; let last=0;
  const frag = document.createDocumentFragment();
  while ((m=fence.exec(text))!==null) {
    const before = text.slice(last,m.index);
    if (before.trim()) renderInline(frag, before);
    const code = document.createElement('div'); code.className='code-block'; code.textContent = m[2];
    frag.appendChild(code);
    last = fence.lastIndex;
  }
  const rest = text.slice(last);
  if (rest.trim()) renderInline(frag, rest);
  container.appendChild(frag);
}

function renderInline(parent, text) {
  const lines = text.split('\n');
  lines.forEach(line => {
    const t = line.trim();
    if (/^(-{3,}|={3,}|\*{3,})$/.test(t)) {
      const sep = document.createElement('div'); sep.className='separator'; parent.appendChild(sep); return;
    }
    const mdImg = t.match(/!\[.*?\]\((.*?)\)/);
    if (mdImg) { appendMedia(parent, mdImg[1]); return; }
    const pdf = t.match(/(https?:\/\/\S+\.pdf|\bdata:application\/pdf;base64,[A-Za-z0-9+/=]+)/i);
    if (pdf) { const iframe=document.createElement('iframe'); iframe.src=pdf[1]; iframe.style.width='100%'; iframe.style.height='420px'; iframe.style.border='1px solid rgba(255,255,255,0.03)'; parent.appendChild(iframe); return; }
    const video = t.match(/(https?:\/\/\S+\.(mp4|webm|ogg)|\bdata:video\/[a-z0-9.+-]+;base64,[A-Za-z0-9+/=]+)/i);
    if (video) { appendMedia(parent, video[1], true); return; }
    const img = t.match(/(https?:\/\/\S+\.(png|jpe?g|gif|webp|svg)|\bdata:image\/[a-z0-9.+-]+;base64,[A-Za-z0-9+/=]+)/i);
    if (img) { appendMedia(parent, img[1]); return; }
    if (/(https?:\/\/\S+)/.test(t)) {
      const d = document.createElement('div'); d.style.marginTop='6px'; d.innerHTML = linkify(escapeHtml(t)); parent.appendChild(d); return;
    }
    if (t.length===0) {
      parent.appendChild(document.createElement('br'));
    } else {
      const p = document.createElement('div'); p.style.whiteSpace='pre-wrap'; p.textContent = line; parent.appendChild(p);
    }
  });
}

function appendMedia(parent, url, isVideo=false) {
  try {
    if (isVideo) { const v=document.createElement('video'); v.src=url; v.controls=true; v.className='media'; parent.appendChild(v); }
    else { const img=document.createElement('img'); img.src=url; img.className='media'; img.alt='image'; parent.appendChild(img); }
  } catch(e) { const a=document.createElement('a'); a.href=url; a.textContent=url; a.target='_blank'; parent.appendChild(a); }
}

function linkify(text){ return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noreferrer" style="color:var(--primary)">$1</a>'); }
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function addMessageToThread(role, content, type='text') {
  const thread = threads.find(t=>t.id===activeThreadId);
  thread.messages.push({role, content, type, ts: Date.now()});
  saveState();
  renderActiveThread();
  renderThreads();
}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;
  if (typeof editMode === 'number') {
    const thread = threads.find(t=>t.id===activeThreadId);
    thread.messages[editMode].content = text;
    editMode = false;
    editModeBtn.textContent = 'Edit';
    userInput.value = '';
    saveState();
    renderActiveThread();
    renderThreads();
    return;
  }
  addMessageToThread('user', text);
  userInput.value = '';
  centerMsg.style.display = 'none';
  const thread = threads.find(t=>t.id===activeThreadId);
  const apiKey = apiKeyInput.value.trim() || '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';
  try {
    const endpoint = 'https://openrouter.ai/api/v1/chat/completions';
    const body = {model:'gpt-4o-mini', messages: thread.messages.map(m=>({role:m.role, content:m.content}))};
    const headers = {"Content-Type":"application/json", "Authorization": "Bearer " + apiKey};
    const res = await fetch(endpoint, {method:'POST', headers, body:JSON.stringify(body)});
    const data = await res.json();
    const aiResp = (data?.choices?.[0]?.message?.content) ? data.choices[0].message.content : (data?.message || "Couldn't generate a response.");
    addMessageToThread('assistant', aiResp);
  } catch(err) {
    addMessageToThread('assistant', 'Error: could not reach API. Ensure API key is correct.');
  }
}

sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keypress', e=> { if (e.key==='Enter') sendMessage(); });

newChatBtn.addEventListener('click', ()=> {
  const id = uid();
  const t = {id, name:'New Chat', messages:[]};
  threads.unshift(t);
  activeThreadId = id;
  saveState();
  renderThreads();
  renderActiveThread();
});

googleImgBtn.addEventListener('click', ()=> {
  const q = encodeURIComponent(prompt('Search Google Images for:','code example') || '');
  if (!q) return;
  window.open('https://www.google.com/search?tbm=isch&q=' + q, '_blank');
});

unsplashBtn.addEventListener('click', ()=> {
  const q = encodeURIComponent(prompt('Unsplash search term:','coding') || 'random');
  const url = `https://source.unsplash.com/1200x800/?${q}`;
  userInput.value = url;
  userInput.focus();
});

renameThreadBtn.addEventListener('click', ()=> {
  const thread = threads.find(t=>t.id===activeThreadId);
  const name = prompt('New name for this chat', thread.name) || thread.name;
  thread.name = name;
  saveState();
  renderThreads();
  renderActiveThread();
});

deleteThreadBtn.addEventListener('click', ()=> {
  if (!confirm('Delete this chat?')) return;
  const idx = threads.findIndex(t=>t.id===activeThreadId);
  threads.splice(idx,1);
  if (!threads.length) { const id = uid(); threads.push({id, name:'New Chat', messages:[]}); }
  activeThreadId = threads[0].id;
  saveState();
  renderThreads();
  renderActiveThread();
});

downloadChatBtn.addEventListener('click', ()=> {
  const thread = threads.find(t=>t.id===activeThreadId);
  const all = thread.messages.map(m=>`${m.role.toUpperCase()}: ${m.content}`).join('\n\n');
  downloadFile((thread.name||'chat') + '.txt', all);
});

clearBtn.addEventListener('click', ()=> {
  userInput.value = '';
});

editModeBtn.addEventListener('click', ()=> {
  if (editMode) { editMode = false; editModeBtn.textContent='Edit'; userInput.value=''; }
  else { alert('To edit a message, click Edit on a user message below.'); }
});

generateImageBtn.addEventListener('click', ()=> {
  const p = prompt('Enter short prompt for an image (Unsplash/placeholder will be used)','coding workspace');
  if (!p) return;
  const url = `https://source.unsplash.com/1200x800/?${encodeURIComponent(p)}`;
  userInput.value = url;
  userInput.focus();
});

generateVideoBtn.addEventListener('click', ()=> {
  const p = prompt('Enter short prompt for a demo video idea (you will receive a sample placeholder URL)','demo');
  if (!p) return;
  const sample = 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4';
  userInput.value = sample;
  userInput.focus();
});

muteBtn.addEventListener('click', ()=> {
  mute = !mute;
  muteBtn.textContent = mute ? 'Muted' : 'Unmute';
});

window.addEventListener('beforeunload', saveState);

function init() { loadState(); }

init();
</script>
</body>
</html>
